<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Firebase Auth Helper</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD-Dyznl9BM4KgBkyQCiMAi3P33XonH8Sg",
            authDomain: window.location.hostname,
            projectId: "eli-s-maths-notes",
            storageBucket: "eli-s-maths-notes.firebasestorage.app",
            messagingSenderId: "580807036777",
            appId: "1:580807036777:web:06f6355c5165b8357277f8",
            measurementId: "G-NKWRMBM90Z"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // This helper page immediately initiates the sign-in redirect
        // or processes the result if redirected back from Google
        auth.getRedirectResult()
            .then(function(result) {
                // Check if there's an authentication result to send back
                if (result.user) {
                    // Send the user data (or a subset) back to the opener window
                    window.opener.postMessage({
                        type: 'FIREBASE_AUTH_SUCCESS',
                        user: {
                            uid: result.user.uid,
                            email: result.user.email,
                            displayName: result.user.displayName,
                            photoURL: result.user.photoURL
                        },
                        accessToken: result.credential?.accessToken // Include token if needed by the opener
                    }, "https://archimedes-314.github.io"); // <-- IMPORTANT: Specify the origin of your main app
                } else if (auth.currentUser) {
                     // If user is already authenticated (e.g. from a previous successful login)
                     window.opener.postMessage({
                        type: 'FIREBASE_AUTH_SUCCESS',
                        user: {
                            uid: auth.currentUser.uid,
                            email: auth.currentUser.email,
                            displayName: auth.currentUser.displayName,
                            photoURL: auth.currentUser.photoURL
                        }
                    }, "https://archimedes-314.github.io");
                }
                // Close the helper window/tab
                window.close();
            })
            .catch(function(error) {
                // Send error back to the opener window
                window.opener.postMessage({
                    type: 'FIREBASE_AUTH_ERROR',
                    code: error.code,
                    message: error.message
                }, "https://archimedes-314.github.io"); // <-- IMPORTANT: Specify the origin of your main app
                window.close();
            });

        // If no user is found and no redirect result is pending, initiate the sign-in
        // This makes sure the helper page always tries to sign in
        if (!auth.currentUser) {
            auth.signInWithRedirect(provider).catch(function(error) {
                // This catch handles errors before the redirect to Google
                window.opener.postMessage({
                    type: 'FIREBASE_AUTH_ERROR',
                    code: error.code,
                    message: error.message
                }, "https://archimedes-314.github.io");
                window.close();
            });
        }
    </script>
</body>
</html>
